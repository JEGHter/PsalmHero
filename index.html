<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PsalmHero</title>
  <style>
    :root { --bg:#0f1221; --card:#171a2d; --text:#e9ecff; --muted:#99a1c7; --good:#3ee079; --warn:#ffcc66; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 700px at 50% -200px,#1b2050,var(--bg));color:var(--text);min-height:100vh;display:grid;place-items:center;padding:24px}
    .app{width:100%;max-width:920px;background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    header{padding:18px 22px;border-bottom:1px solid #202545;display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:700}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:#24305a;color:var(--text);touch-action:manipulation}
    button.primary{background:linear-gradient(135deg,#4b6bff,#7aa2ff);color:#fff}
    button.danger{background:linear-gradient(135deg,#f06666,#ff6b6b);color:#fff}
    main{padding:22px;display:grid;gap:18px}
    .readout{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{background:#111528;border:1px solid #202545;border-radius:12px;padding:14px}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .value{font-size:28px;font-weight:800;margin-top:4px}
    .sub{font-size:13px;color:var(--muted);margin-top:4px}
    .highway-wrap{background:#0d1124;border:1px solid #1a1f3e;border-radius:16px;padding:16px}
    .highway-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .status-dot{width:10px;height:10px;border-radius:999px;background:#ff6b6b;box-shadow:0 0 0 3px rgba(255,107,107,.2)}
    .status-dot.ready{background:var(--warn);box-shadow:0 0 0 3px rgba(255,204,102,.2)}
    .status-dot.live{background:var(--good);box-shadow:0 0 0 3px rgba(62,224,121,.2)}
    .highway{position:relative;height:46px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid #222851;border-radius:12px;overflow:hidden}
    .lane-grid{position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 1px,transparent 1px,transparent 48px);pointer-events:none}
    .target-bar{position:absolute;top:4px;bottom:4px;width:0;border-radius:8px;background:linear-gradient(90deg,#4068ff,#7aa2ff);box-shadow:0 0 18px rgba(122,162,255,.35)}
    .target-bar.hidden{display:none}
    .fill{position:absolute;top:4px;bottom:4px;left:0;width:0%;border-radius:8px;background:linear-gradient(90deg,#29d67a,#6ef0a4);box-shadow:inset 0 0 10px rgba(0,0,0,.3),0 0 18px rgba(46,240,149,.35)}
    .legend{display:flex;gap:16px;align-items:center;color:var(--muted);font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    footer{padding:0 22px 22px;color:var(--muted);font-size:12px}

    /* Bereichsauswahl */
    .range { display:flex; gap:8px; align-items:center; }
    .seg { display:flex; background:#111528; border:1px solid #202545; border-radius:12px; overflow:hidden }
    .seg button {
      background:transparent; border:0; padding:10px 14px; font-weight:800; color:#b7bee6; cursor:pointer;
    }
    .seg button.active { background:#223060; color:#fff; }
    .seg button:disabled { opacity:.5; cursor:not-allowed; }

    /* Skala unter dem Highway */
    .scale-container {
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top: 18px;
      margin-bottom: 10px;
    }
    svg#centScale { width: 320px; height: 54px; }
    .scale-label { font-size: 10px; fill: #b7bee6; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

    @media (max-width:720px){
      .readout{grid-template-columns:1fr}
      svg#centScale { width: 280px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>PsalmHero <span style="opacity:.6;font-weight:600">(Intonationstrainer)</span></h1>

      <div class="controls">
        <div class="range" title="Tonlage auswählen">
          <div class="seg">
            <button id="menBtn" class="active">Männer</button>
            <button id="womenBtn">Frauen</button>
          </div>
        </div>
        <button class="primary" id="startBtn">Start</button>
        <button class="danger" id="stopBtn" disabled>Stopp</button>
      </div>
    </header>

    <main>
      <section class="readout">
        <div class="card"><div class="label">Zielton</div><div class="value" id="targetNote">–</div><div class="sub" id="targetFreq">– Hz</div></div>
        <div class="card"><div class="label">Erkannte Tonhöhe</div><div class="value" id="livePitch">–</div><div class="sub" id="liveCents">–</div></div>
        <div class="card"><div class="label">Trefferquote (letzte Runde)</div><div class="value" id="roundScore">–</div><div class="sub">Zeit innerhalb ±30 Cent (6 s)</div></div>
      </section>

      <section class="highway-wrap">
        <div class="highway-header">
          <div style="display:flex;align-items:center;gap:10px">
            <span class="status-dot" id="statusDot"></span>
            <div class="legend">
              <span><span class="dot" style="background:#ffcc66"></span>Ton wird gespielt (6 s)</span>
              <span><span class="dot" style="background:#3ee079"></span>Pause (3 s)</span>
            </div>
          </div>
          <div id="deltaText" style="color:#99a1c7;font-size:12px;">Δ: –</div>
        </div>

        <div class="highway" id="highway">
          <div class="lane-grid"></div>
          <div class="target-bar hidden" id="targetBar"></div>
          <div class="fill" id="fill"></div>
        </div>

        <!-- Skala ±100 Cent -->
        <div class="scale-container">
          <svg id="centScale" viewBox="0 0 320 54" preserveAspectRatio="xMidYMid meet">
            <line x1="10" y1="20" x2="310" y2="20" stroke="#2a335f" stroke-width="2"/>
            <rect id="tolBand" x="10" y="12" width="300" height="16" fill="#3ee079" opacity="0.12" />
            <g id="ticks" stroke="#8da0d6" stroke-width="2">
              <line x1="10"  y1="16" x2="10"  y2="24"/>
              <line x1="85"  y1="18" x2="85"  y2="22"/>
              <line x1="160" y1="10" x2="160" y2="30" stroke="#bcd0ff"/>
              <line x1="235" y1="18" x2="235" y2="22"/>
              <line x1="260" y1="16" x2="260" y2="24"/>
              <line x1="310" y1="16" x2="310" y2="24"/>
            </g>
            <g class="scale-label">
              <text x="10"  y="40" text-anchor="middle">-100</text>
              <text x="85"  y="40" text-anchor="middle">-25</text>
              <text x="160" y="40" text-anchor="middle">0</text>
              <text x="235" y="40" text-anchor="middle">+25</text>
              <text x="260" y="40" text-anchor="middle">+50</text>
              <text x="310" y="40" text-anchor="middle">+100</text>
            </g>
            <polygon id="centMarker" points="160,32 154,46 166,46" fill="#7aa2ff" stroke="#2b3770" stroke-width="1.2"/>
          </svg>
        </div>
      </section>
    </main>

    <footer>
      <p><strong>Ablauf:</strong> Nach <em>Start</em> spielt ein zufälliger Zielton aus dem gewählten Bereich <strong>6 Sekunden</strong>. Danach folgen <strong>3 Sekunden Pause</strong>. Während der 6 Sekunden füllt sich der grüne Balken, wenn du innerhalb ±30 Cent singst.</p>
    </footer>
  </div>

<script>
/* ===== Musik-Utils ===== */
const A4=440,A4_MIDI=69,NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const midiToFreq=m=>A4*Math.pow(2,(m-A4_MIDI)/12);
const freqToMidi=f=>12*(Math.log2(f/A4))+A4_MIDI;
const midiToName=m=>{const r=Math.round(m);return NOTE_NAMES[r%12]+(Math.floor(r/12)-1);}

/* ===== DOM ===== */
const $=id=>document.getElementById(id);
const startBtn=$("startBtn"),stopBtn=$("stopBtn");
const menBtn=$("menBtn"),womenBtn=$("womenBtn");
const targetNoteEl=$("targetNote"),targetFreqEl=$("targetFreq");
const livePitchEl=$("livePitch"),liveCentsEl=$("liveCents"),roundScoreEl=$("roundScore");
const statusDot=$("statusDot"),targetBar=$("targetBar"),fillEl=$("fill");

/* ===== Audio ===== */
let audioCtx,analyser,micSource,micStream,osc,gain,rafId;
let singPhase=false,onTargetMs=0,singStartTs=0,currentMidi=null,currentFreq=null;
let cycleTimer=null; // 6s + 3s

/* ===== Einstellungen: Bereiche =====
   Männer: A2–C4 (MIDI 45–60)
   Frauen: A3–C5 (MIDI 57–72)
*/
const RANGES = {
  men:   {min:45, max:60, label:"Männer (A2–C4)"},
  women: {min:57, max:72, label:"Frauen (A3–C5)"}
};
// Standard: Männer
let rangeKey = "men";
let RANGE_MIN_MIDI = RANGES[rangeKey].min;
let RANGE_MAX_MIDI = RANGES[rangeKey].max;
const TOL=30;
const SING_MS=6000, PAUSE_MS=3000;

const bufLen=2048,buf=new Float32Array(bufLen);

/* ===== Audio initialisieren ===== */
async function initAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false},video:false});
  micSource=audioCtx.createMediaStreamSource(micStream);
  analyser=audioCtx.createAnalyser();analyser.fftSize=2048;micSource.connect(analyser);
  osc=audioCtx.createOscillator();osc.type='sine';gain=audioCtx.createGain();gain.gain.value=0;osc.connect(gain).connect(audioCtx.destination);osc.start();
}

/* ===== Pitch-Detection (Auto-Korrelation) ===== */
function autoCorrelate(){
  analyser.getFloatTimeDomainData(buf);
  let rms=0;for(let i=0;i<bufLen;i++)rms+=buf[i]*buf[i];
  rms=Math.sqrt(rms/bufLen);if(rms<0.01)return-1;
  let r1=0,r2=bufLen-1,th=0.2;
  for(let i=0;i<bufLen/2;i++)if(Math.abs(buf[i])<th){r1=i;break;}
  for(let i=1;i<bufLen/2;i++)if(Math.abs(buf[bufLen-i])<th){r2=bufLen-i;break;}
  const trimmed=buf.slice(r1,r2),size=trimmed.length,c=new Array(size).fill(0);
  for(let i=0;i<size;i++){for(let j=0;j<size-i;j++)c[i]+=trimmed[j]*trimmed[j+i];}
  let d=0;while(c[d]>c[d+1])d++;let maxval=-1,maxpos=-1;for(let i=d;i<size;i++)if(c[i]>maxval){maxval=c[i];maxpos=i;}
  let T0=maxpos;const x1=c[T0-1]||0,x2=c[T0]||0,x3=c[T0+1]||0;const a=(x1+x3-2*x2)/2,b=(x3-x1)/2;if(a)T0=T0-b/(2*a);
  const f=audioCtx.sampleRate/T0;if(f<50||f>2000||!isFinite(f))return-1;return f;
}

/* ===== UI / Spiel ===== */
function setStatus(m){statusDot.classList.remove("ready","live");if(m==="play")statusDot.classList.add("ready");if(m==="sing")statusDot.classList.add("live");}
function showTargetBar(show,durMs=SING_MS){targetBar.classList.toggle("hidden",!show);if(show){targetBar.style.width="0%";targetBar.animate([{width:"0%"},{width:"100%"}],{duration:durMs,fill:"forwards",easing:"linear"});}}
function resetFill(){fillEl.style.width="0%";}
function setFill(ms,totalMs){fillEl.style.width=Math.max(0,Math.min(100,(ms/totalMs)*100))+"%";}

function playTarget(freq,durMs=SING_MS){
  const t=audioCtx.currentTime;
  gain.gain.cancelScheduledValues(t);
  gain.gain.setValueAtTime(0,t);
  osc.frequency.setValueAtTime(freq,t);
  gain.gain.linearRampToValueAtTime(0.18,t+0.03);
  gain.gain.setValueAtTime(0.18,t+durMs/1000-0.05);
  gain.gain.linearRampToValueAtTime(0.0,t+durMs/1000);
}

function pickRandomMidi(){return Math.floor(Math.random()*(RANGE_MAX_MIDI-RANGE_MIN_MIDI+1))+RANGE_MIN_MIDI;}

function runRound(){
  // neuen Zielton im gewählten Bereich
  currentMidi = pickRandomMidi();
  currentFreq = midiToFreq(currentMidi);
  targetNoteEl.textContent = midiToName(currentMidi);
  targetFreqEl.textContent = currentFreq.toFixed(2)+" Hz";

  // 6 s Singphase
  setStatus("sing"); showTargetBar(true,SING_MS); resetFill();
  playTarget(currentFreq,SING_MS);
  singPhase = true; onTargetMs = 0; singStartTs = performance.now();

  // danach 3 s Pause und nächste Runde
  cycleTimer = setTimeout(()=>{
    singPhase = false; setStatus("play"); showTargetBar(false);
    roundScoreEl.textContent = Math.round((onTargetMs/SING_MS)*100) + " %";

    cycleTimer = setTimeout(()=>{
      setStatus("sing");
      runRound();
    }, PAUSE_MS);

  }, SING_MS);
}

/* Skala-Update (±100 Cent) */
function updateCentScale(cents){
  const marker = document.getElementById("centMarker");
  if(!marker) return;
  const c = Math.max(-100, Math.min(100, cents || 0));
  const x = 10 + ((c + 100) / 200) * 300; // -100..+100 → 10..310
  const topY = 32, baseY = 46;
  marker.setAttribute("points", `${x},${topY} ${x-6},${baseY} ${x+6},${baseY}`);
}

/* ===== Loop ===== */
function loop(){
  const f=analyser?autoCorrelate():-1;
  if(f===-1){
    livePitchEl.textContent="–";liveCentsEl.textContent="–";
    document.getElementById("deltaText").textContent="Δ: –";
    updateCentScale(0);
  }else{
    const name=midiToName(freqToMidi(f));
    const cents=currentFreq?(1200*Math.log2(f/currentFreq)):0;
    livePitchEl.textContent=name;
    liveCentsEl.textContent=f.toFixed(1)+" Hz";
    document.getElementById("deltaText").textContent="Δ: "+(isFinite(cents)?cents.toFixed(0):"–")+" Cent";

    if(singPhase && currentFreq && Math.abs(cents)<=TOL){
      const now=performance.now();
      const elapsed=now-(singStartTs+onTargetMs);
      onTargetMs=Math.min(SING_MS, onTargetMs + Math.min(16, elapsed));
      setFill(onTargetMs, SING_MS);
    }
    updateCentScale(cents);
  }
  rafId=requestAnimationFrame(loop);
}

/* ===== Range-Umschalter ===== */
function setRange(key){
  rangeKey = key;
  RANGE_MIN_MIDI = RANGES[key].min;
  RANGE_MAX_MIDI = RANGES[key].max;
  // Buttons visuell umschalten
  menBtn.classList.toggle('active', key==='men');
  womenBtn.classList.toggle('active', key==='women');
}
menBtn.addEventListener('click', ()=>{ if(startBtn.disabled) return; setRange('men'); });
womenBtn.addEventListener('click', ()=>{ if(startBtn.disabled) return; setRange('women'); });

/* ===== Start/Stop ===== */
async function start(){
  // während Lauf: Umschalter sperren
  menBtn.disabled = true; womenBtn.disabled = true;

  startBtn.disabled=true;stopBtn.disabled=false;
  try{if(!audioCtx)await initAudio();if(audioCtx.state==="suspended")await audioCtx.resume();}
  catch(e){
    alert("Zugriff aufs Mikrofon fehlgeschlagen. Bitte Berechtigung erlauben.");
    startBtn.disabled=false;stopBtn.disabled=true;
    menBtn.disabled = false; womenBtn.disabled = false;
    return;
  }
  runRound(); loop();
}
function stop(){
  startBtn.disabled=false;stopBtn.disabled=true;
  if(rafId) cancelAnimationFrame(rafId);
  if(cycleTimer) clearTimeout(cycleTimer);
  resetFill();
  livePitchEl.textContent="–";liveCentsEl.textContent="–";roundScoreEl.textContent="–";
  targetNoteEl.textContent="–";targetFreqEl.textContent="– Hz";
  if(gain&&audioCtx) gain.gain.setValueAtTime(0,audioCtx.currentTime);

  // Umschalter wieder freigeben
  menBtn.disabled = false; womenBtn.disabled = false;
}
startBtn.addEventListener("click",start);
stopBtn.addEventListener("click",stop);
</script>
</body>
</html>

