<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vokal-Intonations-Trainer</title>
  <style>
    :root { --bg:#0f1221; --card:#171a2d; --text:#e9ecff; --muted:#99a1c7; --good:#3ee079; --warn:#ffcc66; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 700px at 50% -200px,#1b2050,var(--bg));color:var(--text);min-height:100vh;display:grid;place-items:center;padding:24px}
    .app{width:100%;max-width:920px;background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    header{padding:18px 22px;border-bottom:1px solid #202545;display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:700}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#24305a;color:var(--text);touch-action:manipulation}
    button.primary{background:linear-gradient(135deg,#4b6bff,#7aa2ff);color:#fff}
    button.danger{background:linear-gradient(135deg,#f06666,#ff6b6b);color:#fff}
    main{padding:22px;display:grid;gap:18px}
    .readout{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{background:#111528;border:1px solid #202545;border-radius:12px;padding:14px}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .value{font-size:28px;font-weight:800;margin-top:4px}
    .sub{font-size:13px;color:var(--muted);margin-top:4px}
    .highway-wrap{background:#0d1124;border:1px solid #1a1f3e;border-radius:16px;padding:16px}
    .highway-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .status-dot{width:10px;height:10px;border-radius:999px;background:#ff6b6b;box-shadow:0 0 0 3px rgba(255,107,107,.2)}
    .status-dot.ready{background:var(--warn);box-shadow:0 0 0 3px rgba(255,204,102,.2)}
    .status-dot.live{background:var(--good);box-shadow:0 0 0 3px rgba(62,224,121,.2)}
    .highway{position:relative;height:46px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid #222851;border-radius:12px;overflow:hidden}
    .lane-grid{position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 1px,transparent 1px,transparent 48px);pointer-events:none}
    .target-bar{position:absolute;top:4px;bottom:4px;width:0;border-radius:8px;background:linear-gradient(90deg,#4068ff,#7aa2ff);box-shadow:0 0 18px rgba(122,162,255,.35)}
    .target-bar.hidden{display:none}
    .fill{position:absolute;top:4px;bottom:4px;left:0;width:0%;border-radius:8px;background:linear-gradient(90deg,#29d67a,#6ef0a4);box-shadow:inset 0 0 10px rgba(0,0,0,.3),0 0 18px rgba(46,240,149,.35)}
    .legend{display:flex;gap:16px;align-items:center;color:var(--muted);font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    footer{padding:0 22px 12px;color:var(--muted);font-size:12px}

    .seg { display:flex; background:#111528; border:1px solid #202545; border-radius:12px; overflow:hidden }
    .seg button { background:transparent; border:0; padding:8px 14px; font-weight:700; color:#b7bee6; cursor:pointer; }
    .seg button.active { background:#223060; color:#fff; }
    .seg button:disabled { opacity:.55; cursor:not-allowed; }

    .scale-container {
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top: 18px;
      margin-bottom: 10px;
    }
    svg#centScale { width: 320px; height: 54px; }
    .scale-label { font-size: 10px; fill: #b7bee6; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

    #challengePanel {
      background:#111528;
      border:1px solid #202545;
      border-radius:12px;
      padding:14px;
      display:none;
    }
    #challengePanel h3 {
      margin:0 0 10px 0;
      font-size:14px;
    }
    #challengeTable {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    #challengeTable th, #challengeTable td {
      border-bottom:1px solid rgba(255,255,255,0.03);
      padding:6px 4px;
      text-align:left;
    }
    #challengeTable th { color:#b7bee6; font-weight:600; }
    #medalBox {
      margin-top:10px;
      padding:8px 10px;
      background:#0d1124;
      border:1px solid #1a1f3e;
      border-radius:10px;
      display:none;
    }

    #privacy {
      background:#0d1124;
      border-top:1px solid #1a1f3e;
      padding:14px 22px 20px;
      font-size:12px;
      line-height:1.4;
      color:#b7bee6;
    }
    #privacy h3 { margin:0 0 6px 0; font-size:13px; color:#e9ecff; }
    #privacy p { margin:4px 0; }

    @media (max-width:720px){
      .readout{grid-template-columns:1fr}
      svg#centScale { width: 280px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Vokal-Intonations-Trainer <span style="opacity:.6;font-weight:600">(Guitar-Hero-Modus)</span></h1>

      <div class="controls">
        <div class="seg" title="Modus wÃ¤hlen">
          <button id="modeFreeBtn" class="active">Freier Modus</button>
          <button id="modeChallengeBtn">Challenge</button>
        </div>
        <div class="seg" title="Tonlage wÃ¤hlen">
          <button id="menBtn" class="active">MÃ¤nner</button>
          <button id="womenBtn">Frauen</button>
        </div>
        <button class="primary" id="startBtn">Start</button>
        <button class="danger" id="stopBtn" disabled>Stopp</button>
      </div>
    </header>

    <main>
      <section class="readout">
        <div class="card"><div class="label">Zielton</div><div class="value" id="targetNote">â€“</div><div class="sub" id="targetFreq">â€“ Hz</div></div>
        <div class="card"><div class="label">Erkannte TonhÃ¶he</div><div class="value" id="livePitch">â€“</div><div class="sub" id="liveCents">â€“</div></div>
        <div class="card"><div class="label">Trefferquote (letzte Runde)</div><div class="value" id="roundScore">â€“</div><div class="sub">Zeit innerhalb Â±30 Cent (6 s)</div></div>
      </section>

      <section class="highway-wrap">
        <div class="highway-header">
          <div style="display:flex;align-items:center;gap:10px">
            <span class="status-dot" id="statusDot"></span>
            <div class="legend">
              <span><span class="dot" style="background:#ffcc66"></span>Ton wird gespielt (6 s)</span>
              <span><span class="dot" style="background:#3ee079"></span>Pause (3 s)</span>
            </div>
          </div>
          <div id="deltaText" style="color:#99a1c7;font-size:12px;">Î”: â€“</div>
        </div>

        <div class="highway" id="highway">
          <div class="lane-grid"></div>
          <div class="target-bar hidden" id="targetBar"></div>
          <div class="fill" id="fill"></div>
        </div>

        <div class="scale-container">
          <svg id="centScale" viewBox="0 0 320 54" preserveAspectRatio="xMidYMid meet">
            <line x1="10" y1="20" x2="310" y2="20" stroke="#2a335f" stroke-width="2"/>
            <rect id="tolBand" x="10" y="12" width="300" height="16" fill="#3ee079" opacity="0.12" />
            <g id="ticks" stroke="#8da0d6" stroke-width="2">
              <line x1="10"  y1="16" x2="10"  y2="24"/>
              <line x1="85"  y1="18" x2="85"  y2="22"/>
              <line x1="160" y1="10" x2="160" y2="30" stroke="#bcd0ff"/>
              <line x1="235" y1="18" x2="235"  y2="22"/>
              <line x1="260" y1="16" x2="260" y2="24"/>
              <line x1="310" y1="16" x2="310" y2="24"/>
            </g>
            <g class="scale-label">
              <text x="10"  y="40" text-anchor="middle">-100</text>
              <text x="85"  y="40" text-anchor="middle">-25</text>
              <text x="160" y="40" text-anchor="middle">0</text>
              <text x="235" y="40" text-anchor="middle">+25</text>
              <text x="260" y="40" text-anchor="middle">+50</text>
              <text x="310" y="40" text-anchor="middle">+100</text>
            </g>
            <polygon id="centMarker" points="160,32 154,46 166,46" fill="#7aa2ff" stroke="#2b3770" stroke-width="1.2"/>
          </svg>
        </div>
      </section>

      <section id="challengePanel">
        <h3>Challenge-LÃ¤ufe</h3>
        <table id="challengeTable">
          <thead>
            <tr>
              <th style="width:60px">Durchlauf</th>
              <th style="width:140px">Ton</th>
              <th>Ergebnis</th>
            </tr>
          </thead>
          <tbody id="challengeBody">
          </tbody>
        </table>
        <div id="medalBox"></div>
      </section>
    </main>

    <footer>
      <p><strong>Hinweis:</strong> Freier Modus lÃ¤uft durchgehend. Im Challenge-Modus werden 10 Runden gespielt und danach eine Medaille vergeben.</p>
      <p><strong>Wichtig:</strong> Bitte am Handy immer mit KopfhÃ¶rern nutzen, damit der abgespielte Ton nicht ins Mikro gelangt.</p>
    </footer>

    <section id="privacy">
      <h3>Datenschutz-Hinweis â€“ Mikrofonzugriff</h3>
      <p>Diese Anwendung nutzt den Zugriff auf das Mikrofon Ihres EndgerÃ¤ts ausschlieÃŸlich zur lokalen TonhÃ¶henanalyse wÃ¤hrend der Nutzung.</p>
      <p>Die aufgenommenen Audiodaten werden nicht gespeichert, nicht Ã¼bertragen und nicht an Dritte weitergegeben. Die gesamte Verarbeitung der Tonsignale erfolgt ausschlieÃŸlich innerhalb Ihres Webbrowsers (lokal auf Ihrem GerÃ¤t).</p>
      <p>Erst nach Ihrer ausdrÃ¼cklichen Zustimmung (â€žMikrofon erlaubenâ€œ) beginnt die Analyse. Sie kÃ¶nnen den Mikrofonzugriff jederzeit in den Einstellungen Ihres Browsers widerrufen.</p>
      <p>Diese Seite kann Ã¼ber GitHub Pages bereitgestellt werden. Beim Aufruf der Seite werden technisch bedingt Zugriffsdaten (z. B. IP-Adresse, Zeitpunkt, Browser) vom Hosting-Anbieter verarbeitet.</p>
    </section>
  </div>

<script>
/* ===== Musik-Utils ===== */
const A4=440,A4_MIDI=69,NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const midiToFreq=m=>A4*Math.pow(2,(m-A4_MIDI)/12);
const freqToMidi=f=>12*(Math.log2(f/A4))+A4_MIDI;
const midiToName=m=>{const r=Math.round(m);return NOTE_NAMES[r%12]+(Math.floor(r/12)-1);}

/* ===== DOM ===== */
const $=id=>document.getElementById(id);
const startBtn=$("startBtn"),stopBtn=$("stopBtn");
const menBtn=$("menBtn"),womenBtn=$("womenBtn");
const modeFreeBtn=$("modeFreeBtn"),modeChallengeBtn=$("modeChallengeBtn");
const targetNoteEl=$("targetNote"),targetFreqEl=$("targetFreq");
const livePitchEl=$("livePitch"),liveCentsEl=$("liveCents"),roundScoreEl=$("roundScore");
const statusDot=$("statusDot"),targetBar=$("targetBar"),fillEl=$("fill");
const challengePanel=$("challengePanel"),challengeBody=$("challengeBody"),medalBox=$("medalBox");

let audioCtx,analyser,micSource,micStream,osc,gain,rafId;
let singPhase=false,onTargetMs=0,singStartTs=0,currentMidi=null,currentFreq=null;
let cycleTimer=null;

/* Modus & Bereich */
const RANGES = {
  men:   {min:45, max:60},
  women: {min:57, max:72}
};
let rangeKey = "men";
let RANGE_MIN_MIDI = RANGES[rangeKey].min;
let RANGE_MAX_MIDI = RANGES[rangeKey].max;

let MODE = "free";

const TOL=30;
const SING_MS=6000, PAUSE_MS=3000;

const bufLen=2048,buf=new Float32Array(bufLen);

/* Challenge-Variablen */
let challengeRound = 0;
let challengeResults = [];

/* ===== Audio initialisieren ===== */
async function initAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  // KopfhÃ¶rer-Szenario: roh aufnehmen
  micStream=await navigator.mediaDevices.getUserMedia({
    audio:{
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    },
    video:false
  });
  micSource=audioCtx.createMediaStreamSource(micStream);
  analyser=audioCtx.createAnalyser();analyser.fftSize=2048;micSource.connect(analyser);
  osc=audioCtx.createOscillator();osc.type='sine';
  gain=audioCtx.createGain();gain.gain.value=0;
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
}

/* ===== Pitch-Detection ===== */
function autoCorrelate(){
  analyser.getFloatTimeDomainData(buf);
  let rms=0;for(let i=0;i<bufLen;i++)rms+=buf[i]*buf[i];
  rms=Math.sqrt(rms/bufLen);if(rms<0.01)return-1;
  let r1=0,r2=bufLen-1,th=0.2;
  for(let i=0;i<bufLen/2;i++)if(Math.abs(buf[i])<th){r1=i;break;}
  for(let i=1;i<bufLen/2;i++)if(Math.abs(buf[bufLen-i])<th){r2=bufLen-i;break;}
  const trimmed=buf.slice(r1,r2),size=trimmed.length,c=new Array(size).fill(0);
  for(let i=0;i<size;i++){for(let j=0;j<size-i;j++)c[i]+=trimmed[j]*trimmed[j+i];}
  let d=0;while(c[d]>c[d+1])d++;let maxval=-1,maxpos=-1;for(let i=d;i<size;i++)if(c[i]>maxval){maxval=c[i];maxpos=i;}
  let T0=maxpos;const x1=c[T0-1]||0,x2=c[T0]||0,x3=c[T0+1]||0;const a=(x1+x3-2*x2)/2,b=(x3-x1)/2;if(a)T0=T0-b/(2*a);
  const f=audioCtx.sampleRate/T0;if(f<50||f>2000||!isFinite(f))return-1;return f;
}

/* ===== UI ===== */
function setStatus(m){statusDot.classList.remove("ready","live");if(m==="play")statusDot.classList.add("ready");if(m==="sing")statusDot.classList.add("live");}
function showTargetBar(show,durMs=SING_MS){targetBar.classList.toggle("hidden",!show);if(show){targetBar.style.width="0%";targetBar.animate([{width:"0%"},{width:"100%"}],{duration:durMs,fill:"forwards",easing:"linear"});}}
function resetFill(){fillEl.style.width="0%";}
function setFill(ms,totalMs){fillEl.style.width=Math.max(0,Math.min(100,(ms/totalMs)*100))+"%";}

/* Ton abspielen â€“ lauter fÃ¼r Handy + KopfhÃ¶rer */
function playTarget(freq,durMs=SING_MS){
  const t=audioCtx.currentTime;
  gain.gain.cancelScheduledValues(t);
  gain.gain.setValueAtTime(0,t);
  osc.frequency.setValueAtTime(freq,t);
  gain.gain.linearRampToValueAtTime(0.3,t+0.03);
  gain.gain.setValueAtTime(0.3,t+durMs/1000-0.05);
  gain.gain.linearRampToValueAtTime(0.0,t+durMs/1000);
}

function pickRandomMidi(){return Math.floor(Math.random()*(RANGE_MAX_MIDI-RANGE_MIN_MIDI+1))+RANGE_MIN_MIDI;}

/* Challenge-Helfer */
function challengeResetUI(){
  challengeBody.innerHTML = "";
  medalBox.style.display = "none";
}
function challengeAddRow(round, note, score){
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${round}.</td><td>${note}</td><td>${score} %</td>`;
  challengeBody.appendChild(tr);
}
function challengeFinish(){
  if(challengeResults.length === 0) return;
  const avg = Math.round(challengeResults.reduce((s,r)=>s+r.score,0)/challengeResults.length);
  let text = "Keine Medaille";
  let emoji = "â€”";
  if (avg >= 95){ text = "Gold"; emoji = "ðŸ¥‡"; }
  else if (avg >= 85){ text = "Silber"; emoji = "ðŸ¥ˆ"; }
  else if (avg >= 75){ text = "Bronze"; emoji = "ðŸ¥‰"; }

  medalBox.style.display = "block";
  medalBox.innerHTML = `<strong>Durchschnitt:</strong> ${avg} %<br><strong>Ergebnis:</strong> ${emoji} ${text}`;

  startBtn.disabled = false;
  stopBtn.disabled = true;
  menBtn.disabled = false;
  womenBtn.disabled = false;
  modeFreeBtn.disabled = false;
  modeChallengeBtn.disabled = false;
}

/* Freier Modus Runde */
function runFreeRound(){
  currentMidi = pickRandomMidi();
  currentFreq = midiToFreq(currentMidi);
  targetNoteEl.textContent = midiToName(currentMidi);
  targetFreqEl.textContent = currentFreq.toFixed(2)+" Hz";

  setStatus("sing"); showTargetBar(true,SING_MS); resetFill();
  playTarget(currentFreq,SING_MS);
  singPhase = true; onTargetMs = 0; singStartTs = performance.now();

  cycleTimer = setTimeout(()=>{
    singPhase = false; setStatus("play"); showTargetBar(false);
    roundScoreEl.textContent = Math.round((onTargetMs/SING_MS)*100)+" %";

    cycleTimer = setTimeout(()=>{
      setStatus("sing");
      runFreeRound();
    }, PAUSE_MS);

  }, SING_MS);
}

/* Challenge Runde */
function runChallengeRound(){
  if (challengeRound >= 10){
    challengeFinish();
    return;
  }
  challengeRound++;

  currentMidi = pickRandomMidi();
  currentFreq = midiToFreq(currentMidi);
  targetNoteEl.textContent = midiToName(currentMidi);
  targetFreqEl.textContent = currentFreq.toFixed(2)+" Hz";

  setStatus("sing"); showTargetBar(true,SING_MS); resetFill();
  playTarget(currentFreq,SING_MS);
  singPhase = true; onTargetMs = 0; singStartTs = performance.now();

  cycleTimer = setTimeout(()=>{
    singPhase = false; setStatus("play"); showTargetBar(false);
    const score = Math.round((onTargetMs/SING_MS)*100);
    roundScoreEl.textContent = score+" %";
    challengeResults.push({round: challengeRound, note: midiToName(currentMidi), score});
    challengeAddRow(challengeRound, midiToName(currentMidi), score);

    if (challengeRound >= 10){
      challengeFinish();
    } else {
      cycleTimer = setTimeout(()=>{
        runChallengeRound();
      }, PAUSE_MS);
    }

  }, SING_MS);
}

/* Skala */
function updateCentScale(cents){
  const marker = document.getElementById("centMarker");
  if(!marker) return;
  const c = Math.max(-100, Math.min(100, cents || 0));
  const x = 10 + ((c + 100) / 200) * 300;
  const topY = 32, baseY = 46;
  marker.setAttribute("points", `${x},${topY} ${x-6},${baseY} ${x+6},${baseY}`);
}

/* Loop */
function loop(){
  const f=analyser?autoCorrelate():-1;
  if(f===-1){
    livePitchEl.textContent="â€“";liveCentsEl.textContent="â€“";
    document.getElementById("deltaText").textContent="Î”: â€“";
    updateCentScale(0);
  }else{
    const name=midiToName(freqToMidi(f));
    const cents=currentFreq?(1200*Math.log2(f/currentFreq)):0;
    livePitchEl.textContent=name;
    liveCentsEl.textContent=f.toFixed(1)+" Hz";
    document.getElementById("deltaText").textContent="Î”: "+(isFinite(cents)?cents.toFixed(0):"â€“")+" Cent";

    if(singPhase && currentFreq && Math.abs(cents)<=TOL){
      const now=performance.now();
      const elapsed=now-(singStartTs+onTargetMs);
      onTargetMs=Math.min(SING_MS, onTargetMs + Math.min(16, elapsed));
      setFill(onTargetMs, SING_MS);
    }
    updateCentScale(cents);
  }
  rafId=requestAnimationFrame(loop);
}

/* Umschalter Tonlage */
function setRange(key){
  rangeKey = key;
  RANGE_MIN_MIDI = RANGES[key].min;
  RANGE_MAX_MIDI = RANGES[key].max;
  menBtn.classList.toggle('active', key==='men');
  womenBtn.classList.toggle('active', key==='women');
}
menBtn.addEventListener('click', ()=>{ if(startBtn.disabled) return; setRange('men'); });
womenBtn.addEventListener('click', ()=>{ if(startBtn.disabled) return; setRange('women'); });

/* Umschalter Modus */
function setMode(newMode){
  MODE = newMode;
  modeFreeBtn.classList.toggle('active', newMode==='free');
  modeChallengeBtn.classList.toggle('active', newMode==='challenge');
  challengePanel.style.display = (newMode === 'challenge') ? 'block' : 'none';
}
modeFreeBtn.addEventListener('click', ()=>{ if(startBtn.disabled) return; setMode('free'); });
modeChallengeBtn.addEventListener('click', ()=>{ if(startBtn.disabled) return; setMode('challenge'); });

/* Start/Stop */
async function start(){
  menBtn.disabled = true; womenBtn.disabled = true;
  modeFreeBtn.disabled = true; modeChallengeBtn.disabled = true;

  startBtn.disabled=true;stopBtn.disabled=false;
  try{
    if(!audioCtx)await initAudio();
    if(audioCtx.state==="suspended")await audioCtx.resume();
  }catch(e){
    alert("Zugriff aufs Mikrofon fehlgeschlagen. Bitte Berechtigung erlauben.");
    startBtn.disabled=false;stopBtn.disabled=true;
    menBtn.disabled = false; womenBtn.disabled = false;
    modeFreeBtn.disabled = false; modeChallengeBtn.disabled = false;
    return;
  }

  if (MODE === 'challenge'){
    challengeRound = 0;
    challengeResults = [];
    challengeResetUI();
    runChallengeRound();
  } else {
    runFreeRound();
  }
  loop();
}

function stop(){
  startBtn.disabled=false;stopBtn.disabled=true;
  if(rafId) cancelAnimationFrame(rafId);
  if(cycleTimer) clearTimeout(cycleTimer);
  resetFill();
  livePitchEl.textContent="â€“";liveCentsEl.textContent="â€“";roundScoreEl.textContent="â€“";
  targetNoteEl.textContent="â€“";targetFreqEl.textContent="â€“ Hz";
  if(gain&&audioCtx) gain.gain.setValueAtTime(0,audioCtx.currentTime);

  menBtn.disabled = false; womenBtn.disabled = false;
  modeFreeBtn.disabled = false; modeChallengeBtn.disabled = false;
}
startBtn.addEventListener("click",start);
stopBtn.addEventListener("click",stop);
</script>
</body>
</html>
