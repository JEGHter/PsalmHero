<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vokal-Intonations-Trainer</title>
  <style>
    :root { --bg:#0f1221; --card:#171a2d; --text:#e9ecff; --muted:#99a1c7; --good:#3ee079; --warn:#ffcc66; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 700px at 50% -200px,#1b2050,var(--bg));color:var(--text);min-height:100vh;display:grid;place-items:center;padding:24px}
    .app{width:100%;max-width:820px;background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    header{padding:18px 22px;border-bottom:1px solid #202545;display:flex;align-items:center;gap:12px;justify-content:space-between}
    h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:700}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#24305a;color:var(--text)}
    button.primary{background:linear-gradient(135deg,#4b6bff,#7aa2ff);color:#fff}
    button.danger{background:linear-gradient(135deg,#f06666,#ff6b6b);color:#fff}
    main{padding:22px;display:grid;gap:18px}
    .readout{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{background:#111528;border:1px solid #202545;border-radius:12px;padding:14px}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .value{font-size:28px;font-weight:800;margin-top:4px}
    .sub{font-size:13px;color:var(--muted);margin-top:4px}
    .highway-wrap{background:#0d1124;border:1px solid #1a1f3e;border-radius:16px;padding:16px}
    .highway-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .status-dot{width:10px;height:10px;border-radius:999px;background:#ff6b6b;box-shadow:0 0 0 3px rgba(255,107,107,.2)}
    .status-dot.ready{background:var(--warn);box-shadow:0 0 0 3px rgba(255,204,102,.2)}
    .status-dot.live{background:var(--good);box-shadow:0 0 0 3px rgba(62,224,121,.2)}
    .highway{position:relative;height:46px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid #222851;border-radius:12px;overflow:hidden}
    .lane-grid{position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 1px,transparent 1px,transparent 48px);pointer-events:none}
    .target-bar{position:absolute;top:4px;bottom:4px;width:0;border-radius:8px;background:linear-gradient(90deg,#4068ff,#7aa2ff);box-shadow:0 0 18px rgba(122,162,255,.35)}
    .target-bar.hidden{display:none}
    .fill{position:absolute;top:4px;bottom:4px;left:0;width:0%;border-radius:8px;background:linear-gradient(90deg,#29d67a,#6ef0a4);box-shadow:inset 0 0 10px rgba(0,0,0,.3),0 0 18px rgba(46,240,149,.35)}
    .legend{display:flex;gap:16px;align-items:center;color:var(--muted);font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    footer{padding:0 22px 22px;color:var(--muted);font-size:12px}
    @media (max-width:720px){.readout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Vokal-Intonations-Trainer <span style="opacity:.6;font-weight:600">(Guitar-Hero-Modus)</span></h1>
      <div class="controls">
        <button class="primary" id="startBtn">Start</button>
        <button class="danger" id="stopBtn" disabled>Stopp</button>
      </div>
    </header>

    <main>
      <section class="readout">
        <div class="card"><div class="label">Zielton</div><div class="value" id="targetNote">–</div><div class="sub" id="targetFreq">– Hz</div></div>
        <div class="card"><div class="label">Erkannte Tonhöhe</div><div class="value" id="livePitch">–</div><div class="sub" id="liveCents">–</div></div>
        <div class="card"><div class="label">Trefferquote (letzte Runde)</div><div class="value" id="roundScore">–</div><div class="sub">Zeit innerhalb ±30 Cent</div></div>
      </section>

      <section class="highway-wrap">
        <div class="highway-header">
          <div style="display:flex;align-items:center;gap:10px">
            <span class="status-dot" id="statusDot"></span>
            <div class="legend">
              <span><span class="dot" style="background:#ffcc66"></span>Ton wird gespielt (1s)</span>
              <span><span class="dot" style="background:#3ee079"></span>Sing-Phase (3s)</span>
            </div>
          </div>
          <div class="pitch-delta" id="deltaText" style="color:#99a1c7;font-size:12px;">Δ: –</div>
        </div>
        <div class="highway" id="highway">
          <div class="lane-grid"></div>
          <div class="target-bar hidden" id="targetBar"></div>
          <div class="fill" id="fill"></div>
        </div>
      </section>
    </main>

    <footer>
      <p><strong>So funktioniert's:</strong> Nach <em>Start</em> erscheint alle 5 Sekunden ein zufälliger Zielton zwischen <em>C4</em> und <em>D5</em>. Der Ton klingt 1 Sekunde. Danach hast du 3 Sekunden, um den Ton zu singen. Wenn du innerhalb ±30 Cent triffst, füllt sich der grüne Balken.</p>
    </footer>
  </div>

<script>
const A4=440,A4_MIDI=69,NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const midiToFreq=m=>A4*Math.pow(2,(m-A4_MIDI)/12),freqToMidi=f=>12*(Math.log2(f/A4))+A4_MIDI,centsOff=(d,t)=>1200*Math.log2(d/t);
const midiToName=m=>{const r=Math.round(m);return NOTE_NAMES[r%12]+(Math.floor(r/12)-1);}
const MIN_MIDI=60,MAX_MIDI=74,TOL=30;

const $=id=>document.getElementById(id);
const startBtn=$("startBtn"),stopBtn=$("stopBtn"),targetNoteEl=$("targetNote"),targetFreqEl=$("targetFreq");
const livePitchEl=$("livePitch"),liveCentsEl=$("liveCents"),roundScoreEl=$("roundScore");
const statusDot=$("statusDot"),targetBar=$("targetBar"),fillEl=$("fill"),deltaText=$("deltaText");

let audioCtx,analyser,micSource,micStream,osc,gain,rafId,roundTimer;
let singPhase=false,onTargetMs=0,singStartTs=0,currentMidi=null,currentFreq=null;

async function initAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false},video:false});
  micSource=audioCtx.createMediaStreamSource(micStream);
  analyser=audioCtx.createAnalyser();analyser.fftSize=2048;micSource.connect(analyser);
  osc=audioCtx.createOscillator();osc.type="sine";gain=createGain();gain.gain.value=0;osc.connect(gain).connect(audioCtx.destination);osc.start();
  function createGain(){return audioCtx.createGain()}
}

const bufLen=2048,buf=new Float32Array(bufLen);
function autoCorrelate(){
  analyser.getFloatTimeDomainData(buf);
  let rms=0;for(let i=0;i<bufLen;i++)rms+=buf[i]*buf[i];rms=Math.sqrt(rms/bufLen);if(rms<0.01)return-1;
  let r1=0,r2=bufLen-1,th=0.2;
  for(let i=0;i<bufLen/2;i++)if(Math.abs(buf[i])<th){r1=i;break;}
  for(let i=1;i<bufLen/2;i++)if(Math.abs(buf[bufLen-i])<th){r2=bufLen-i;break;}
  const trimmed=buf.slice(r1,r2),size=trimmed.length,c=new Array(size).fill(0);
  for(let i=0;i<size;i++){for(let j=0;j<size-i;j++)c[i]+=trimmed[j]*trimmed[j+i];}
  let d=0;while(c[d]>c[d+1])d++;let maxval=-1,maxpos=-1;for(let i=d;i<size;i++)if(c[i]>maxval){maxval=c[i];maxpos=i;}
  let T0=maxpos;const x1=c[T0-1]||0,x2=c[T0]||0,x3=c[T0+1]||0;const a=(x1+x3-2*x2)/2,b=(x3-x1)/2;if(a)T0=T0-b/(2*a);
  const f=audioCtx.sampleRate/T0;if(f<50||f>2000||!isFinite(f))return-1;return f;
}

function setStatus(m){statusDot.classList.remove("ready","live");if(m==="play")statusDot.classList.add("ready");if(m==="sing")statusDot.classList.add("live");}
function showTargetBar(show){targetBar.classList.toggle("hidden",!show);if(show){targetBar.style.width="0%";targetBar.animate([{width:"0%"},{width:"100%"}],{duration:3000,fill:"forwards",easing:"linear"});}}
function resetFill(){fillEl.style.width="0%";}
function setFill(ms){fillEl.style.width=Math.max(0,Math.min(100,(ms/3000)*100))+"%";}
function playTarget(freq){
  gain.gain.cancelScheduledValues(audioCtx.currentTime);
  gain.gain.setValueAtTime(0,audioCtx.currentTime);
  osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.18,audioCtx.currentTime+0.02);
  gain.gain.linearRampToValueAtTime(0.18,audioCtx.currentTime+0.98);
  gain.gain.linearRampToValueAtTime(0.0,audioCtx.currentTime+1.00);
}

function pickRandomMidi(){return Math.floor(Math.random()*(MAX_MIDI-MIN_MIDI+1))+MIN_MIDI;}

function startRound(){
  currentMidi=pickRandomMidi();currentFreq=midiToFreq(currentMidi);
  targetNoteEl.textContent=midiToName(currentMidi);
  targetFreqEl.textContent=currentFreq.toFixed(2)+" Hz";
  setStatus("play");showTargetBar(false);resetFill();playTarget(currentFreq);
  setTimeout(()=>{
    setStatus("sing");showTargetBar(true);singPhase=true;onTargetMs=0;singStartTs=performance.now();
    setTimeout(()=>{
      singPhase=false;setStatus("idle");showTargetBar(false);
      roundScoreEl.textContent=Math.round((onTargetMs/3000)*100)+"%";
    },3000);
  },1000);
}

function loop(){
  const f=analyser?autoCorrelate():-1;
  if(f===-1){livePitchEl.textContent="–";liveCentsEl.textContent="–";deltaText.textContent="Δ: –";}
  else{
    const name=midiToName(freqToMidi(f)); const cents=currentFreq?(1200*Math.log2(f/currentFreq)):0;
    livePitchEl.textContent=name; liveCentsEl.textContent=f.toFixed(1)+" Hz";
    deltaText.textContent="Δ: "+(isFinite(cents)?cents.toFixed(0):"–")+" cent";
    if(singPhase && currentFreq && Math.abs(cents)<=TOL){
      const now=performance.now(); const elapsed=now-(singStartTs+onTargetMs);
      onTargetMs=Math.min(3000,onTargetMs+Math.min(16,elapsed)); setFill(onTargetMs);
    }
  }
  rafId=requestAnimationFrame(loop);
}

async function start(){
  startBtn.disabled=true; stopBtn.disabled=false;
  try{ if(!audioCtx) await initAudio(); if(audioCtx.state==="suspended") await audioCtx.resume(); }
  catch(e){ alert("Zugriff aufs Mikrofon fehlgeschlagen. Bitte Berechtigung erlauben."); startBtn.disabled=false; stopBtn.disabled=true; return; }
  startRound(); roundTimer=setInterval(startRound,5000); loop();
}
function stop(){
  startBtn.disabled=false; stopBtn.disabled=true; cancelAnimationFrame(rafId); clearInterval(roundTimer);
  resetFill(); livePitchEl.textContent="–"; liveCentsEl.textContent="–"; roundScoreEl.textContent="–";
  targetNoteEl.textContent="–"; targetFreqEl.textContent="– Hz";
  if(gain&&audioCtx) gain.gain.setValueAtTime(0,audioCtx.currentTime);
}

startBtn.addEventListener("click",start); stopBtn.addEventListener("click",stop);
window.addEventListener("visibilitychange",()=>{ if(document.hidden && gain) gain.gain.value=0; });
</script>
</body>
</html>
