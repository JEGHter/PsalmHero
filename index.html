<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>PsalmHero ‚Äì Mette (EG) √úbe‚ÄëWidget mit Highway</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#111827; --ok:#16a34a; --hi:#ea580c; --lo:#2563eb; --rail:#e5e7eb }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--ink)}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:1px solid #e5e7eb;background:#111827;color:#fff;border-radius:14px;padding:12px 18px;font-weight:600;font-size:16px;line-height:1.2}
    button.secondary{background:#fff;color:var(--ink)}
    button.ghost{background:#fff;color:var(--ink);border-style:dashed}
    button:disabled{opacity:.6}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .title{margin:0 0 10px 0;font-size:18px}
    .row{display:flex;justify-content:space-between;align-items:baseline;margin:8px 0}
    .muted{color:var(--muted);font-size:13px}
    .bar{height:10px;background:var(--rail);border-radius:999px;overflow:hidden}
    .bar>div{height:100%;width:0}
    .syll{display:inline-block;padding:8px 12px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;margin:6px 6px 0 0}
    .syll.active{background:#000;color:#fff;border-color:#000}
    .inputs label{display:block;font-size:13px;margin:8px 0 4px}
    input[type="range"], select{width:100%}
    input[type="text"], input[type="number"]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .hint{font-size:12px;color:var(--muted)}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:600}
    .partrow{display:grid;grid-template-columns:1fr auto;gap:8px;width:100%}
    canvas{display:block;width:100%;height:280px;background:#0b1220;border-radius:14px;border:1px solid #1f2a44}
    @media(max-width:640px){
      .toolbar{gap:10px}
      button{font-size:17px;padding:14px 18px;border-radius:16px}
      canvas{height:300px}
    }
    .legend{display:flex;justify-content:space-between;align-items:center;margin:6px 0 0;color:#94a3b8;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button type="button" id="btnPlay" onclick="return window.PS_play && window.PS_play();">‚ñ∂Ô∏è Play</button>
      <button type="button" id="btnStop" onclick="return window.PS_stop && window.PS_stop();" class="secondary">‚èπÔ∏è Stop</button>
      <button type="button" id="btnMic" onclick="return window.PS_mic && window.PS_mic();" class="ghost">üéôÔ∏è Mikro an</button>
      <button type="button" id="btnTest" onclick="return window.PS_test && window.PS_test();" class="ghost">üîä Test‚ÄëTon</button>
      <span class="badge">PsalmHero ‚Äì Mette (EG, C‚ÄëDur)</span>
      <span id="status" class="muted" style="margin-left:8px"></span>
    </div>

    <div class="grid">
      <div class="card">
        <h2 class="title">Live‚Äë√úbung</h2>
        <canvas id="highway" width="800" height="260"></canvas>
        <div class="legend"><span>Note‚ÄëHighway</span><span>Treff‚ÄëLinie ‚ñ≤</span></div>
        <div class="row"><div class="muted">Zielnote</div><div id="targetNote">‚Äì</div></div>
        <div class="row"><div class="muted">Erkannte Note</div><div id="detectedNote">‚Äì</div></div>
        <div class="bar" aria-label="Abweichungsbalken"><div id="devBar"></div></div>
        <div class="muted" id="devText" style="margin-top:6px">Abweichung: ‚Äì</div>
        <div id="syllWrap" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3 class="title">Mette‚ÄëTeile & Einstellungen</h3>
        <div class="inputs">
          <label>Teil ausw√§hlen</label>
          <div class="partrow">
            <select id="part">
              <option value="invitatorium_antiphon">Invitatorium ‚Äì Antiphon</option>
              <option value="invitatorium_psalmvers">Invitatorium ‚Äì Psalmvers</option>
              <option value="eroeffnung">Er√∂ffnung (Versikel/Antwort)</option>
              <option value="responsorium">Responsorium kurz</option>
              <option value="benedictus_antiphon">Benedictus ‚Äì Antiphon</option>
              <option value="vaterunser">Vaterunser (Antwortton)</option>
              <option value="segen">Segen (kurz)</option>
            </select>
            <button id="btnLoadPart" class="secondary" onclick="return window.PS_load && window.PS_load();">Laden</button>
          </div>

          <label><input type="checkbox" id="showNotation" checked /> Notenbild auf Notenlinien anzeigen</label>

          <label>Guide‚ÄëLautst√§rke</label>
          <input type="range" id="gain" min="0" max="0.8" step="0.02" value="0.2" />

          <label>Tempo: <span id="bpmVal">70</span> BPM</label>
          <input type="range" id="bpm" min="40" max="120" step="1" value="70" />

          <label>Silben (mit | trennen)</label>
          <input type="text" id="sylText" value="Kommt|lasst|uns|anbeten~" />
          <div class="hint">Texte ggf. selbst einf√ºgen (Urheberrecht beachten). Dauer: Suffix ~ = 2 Schl√§ge, ^ = 3 Schl√§ge (z.B. "Herr~").</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="number" id="rootNum" value="60" />
            <button id="btnRebuild" class="secondary" style="flex:1">Neu aufbauen</button>
          </div>
          <div style="margin-top:8px">
            <label><input type="checkbox" id="psalmMode" /> Psalmton‚ÄëModus (Rezitation + Kadenz)</label>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <strong>Hinweise</strong>
      <ul>
        <li>Funktioniert im Handy‚ÄëBrowser. Mikrofon ben√∂tigt <em>HTTPS</em> und Freigabe.</li>
        <li>iOS: Audio startet nach Button‚ÄëKlick (Safari‚ÄëPolicy).</li>
        <li>Die Inhalte der Mette im EG sind urheberrechtlich gesch√ºtzt. Trage eigene/√∂ffentliche Texte ein; die vorliegenden sind Platzhalter.</li>
      </ul>
    </div>
  </div>

  <script>
    // ====== Tonh√∂he & Skalen (C-Dur fest) ======
    const A4 = 440;
    const midiToFreq = m => A4 * Math.pow(2, (m - 69) / 12);
    const freqToMidi = f => Math.round(69 + 12 * Math.log2(f / A4));
    const midiToName = (m) => { const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]; const n = m % 12; const oct = Math.floor(m/12)-1; return names[n]+oct };
    const SCALE_MAJOR = [0,2,4,5,7,9,11]; // C-Dur als Bezug; root=60 (C4)

    // ====== Mette-Parts (Platzhaltertexte) ======
    const PARTS = {
      eroeffnung: { title: "Er√∂ffnung (Versikel/Antwort)", text: "Herr|√∂ffne|meine|Lippen~|dass|mein|Mund|dein|Lob|verk√ºndige~", degrees: [0,2,4,4,4,5,4,2,0,0] },
      invitatorium_antiphon: { title: "Invitatorium ‚Äì Antiphon", text: "Kommt|lasst|uns|anbeten~", degrees: [0,0,2,0] },
      invitatorium_psalmvers: { title: "Invitatorium ‚Äì Psalmvers (Psalmton)", text: "Kommt|lasst|uns|mit|Frohlocken|dem|HERRN|zujauchzen~", mode: 'psalmtone' },
      responsorium: { title: "Responsorium kurz", text: "Singet|dem|HERRN|ein|neues|Lied~", degrees: [0,2,4,5,4,2] },
      benedictus_antiphon: { title: "Benedictus ‚Äì Antiphon", text: "Gepriesen|sei|der|Herr|der|Gott|Israels~", degrees: [0,0,2,4,5,4,2] },
      vaterunser: { title: "Vaterunser (Antwortton)", text: "Vater|unser|im|Himmel|geheiligt|werde|dein|Name~", mode: 'psalmtone' },
      segen: { title: "Segen (kurz)", text: "Der|Herr|segne|und|beh√ºte|dich~", degrees: [0,2,4,4,2,0] }
    };

    // ====== State ======
    let bpm = 70, gainVal = 0.2, root = 60; // C4
    let syllables = [];
    let currentIdx = 0; let playing = false; let listening = false; let timer = null;

    // ====== DOM ======
    const $ = (id)=>document.getElementById(id);
    const targetNoteEl = $('targetNote');
    const detectedNoteEl = $('detectedNote');
    const devBarEl = $('devBar');
    const devTextEl = $('devText');
    const syllWrapEl = $('syllWrap');
    const canvas = $('highway');
    const g = canvas.getContext('2d');

    // Highway visuals (responsive for Wix)
    const view = { w: 0, h: 0, pxPerBeat: 90, hitX: 110 };

    function sizeCanvas(){
      const pr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth || 800;
      const cssH = Math.max(240, Math.min(420, Math.round(cssW * 0.34)));
      canvas.width  = Math.floor(cssW * pr);
      canvas.height = Math.floor(cssH * pr);
      canvas.style.height = cssH + 'px';
      view.w = canvas.width; view.h = canvas.height;
      view.hitX = Math.round(0.14 * view.w);
      view.pxPerBeat = Math.max(60, Math.min(140, Math.round(view.w / 8)));
    }

    // ====== Audio ======
    let ctx = null, masterGain = null;
    function ensureAudio(){ if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)(); masterGain = ctx.createGain(); masterGain.gain.value = gainVal; masterGain.connect(ctx.destination); } }
    function playGuide(freq, durMs){ ensureAudio(); const gnode = ctx.createGain(); const osc = ctx.createOscillator(); osc.type='sine'; osc.frequency.value=freq; osc.connect(gnode); gnode.connect(masterGain); const now=ctx.currentTime, a=0.01, r=0.08; gnode.gain.setValueAtTime(0,now); gnode.gain.linearRampToValueAtTime(1,now+a); gnode.gain.setTargetAtTime(0, now + durMs/1000 - r, r); osc.start(now); osc.stop(now + durMs/1000 + 0.02); }

    // ====== Pitch Detection (Autokorrelation) ======
    let micStream=null, analyser=null, micBuf=null, rafId=null; let lastFreq=null, lastCents=null;
    function autoCorrelateFloat32(buf){ const SIZE=buf.length; let rms=0; for(let i=0;i<SIZE;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/SIZE); if(rms<0.01) return null; let r1=0,r2=SIZE-1,th=0.2; for(let i=0;i<SIZE/2;i++){ if(Math.abs(buf[i])<th){r1=i;break;} } for(let i=1;i<SIZE/2;i++){ if(Math.abs(buf[SIZE-i])<th){r2=SIZE-i;break;} } buf=buf.slice(r1,r2); const N=buf.length; const ac=new Float32Array(N); for(let lag=0; lag<N; lag++){ let sum=0; for(let i=0;i<N-lag;i++) sum+=buf[i]*buf[i+lag]; ac[lag]=sum; } let d=0; while(d<N && ac[d]>ac[d+1]) d++; let maxPos=d,maxVal=-1; for(let i=d;i<N;i++){ if(ac[i]>maxVal){maxVal=ac[i]; maxPos=i;} } if(maxPos===0) return null; const x1=ac[maxPos-1]||0, x2=ac[maxPos], x3=ac[maxPos+1]||0; const shift=(x3-x1)/(2*(2*x2-x1-x3)); const period=(maxPos+shift); const f=(ctx?ctx.sampleRate:48000)/period; if(f<60||f>1000) return null; return f; }
    function startListening(){ if(listening) return; ensureAudio(); navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(stream=>{ micStream=stream; const src=ctx.createMediaStreamSource(stream); analyser=ctx.createAnalyser(); analyser.fftSize=2048; src.connect(analyser); micBuf=new Float32Array(analyser.fftSize); listening=true; $('btnMic').textContent='üéôÔ∏è Mikro aus'; const loop=()=>{ analyser.getFloatTimeDomainData(micBuf); const f=autoCorrelateFloat32(micBuf); updateDetected(f); rafId=requestAnimationFrame(loop); }; loop(); }).catch(e=>{ alert('Mikrofonzugriff fehlgeschlagen ‚Äì bitte Berechtigungen & HTTPS pr√ºfen.'); console.error(e); }); }
    function stopListening(){ listening=false; $('btnMic').textContent='üéôÔ∏è Mikro an'; if(rafId) cancelAnimationFrame(rafId); if(micStream){ micStream.getTracks().forEach(t=>t.stop()); } }

    // ====== Psalmton-Generator (C-Dur) ======
    function buildPsalmToneDegrees(n){ const scale = SCALE_MAJOR; const domIndex = 4; // Dominante (G)
      const line = new Array(Math.max(1,n)).fill(scale[domIndex]); if(n>=3){ line[n-3] = Math.max(0, scale[domIndex]-1); line[n-2] = scale[domIndex]+1; line[n-1] = scale[domIndex]; } return line; }

    // ====== Build syllables & notes ======
    function makeNotesFromSyllables(list){ return list.map(s => ({...s, dur: s.text.endsWith('~')?2:(s.text.endsWith('^')?3:1)})); }

    function buildFromText(){ const raw = $('sylText').value; const parts = raw.split('|').map(s=>s.trim()).filter(Boolean); const base = parseInt($('rootNum').value||root,10); root = base; let degrees; if($('psalmMode').checked){ degrees = buildPsalmToneDegrees(parts.length); } else { degrees = SCALE_MAJOR; }
      const out = parts.map((p,i)=>({ text:p, midi: base + ( $('psalmMode').checked ? degrees[i] : degrees[i % degrees.length] ) }));
      syllables = makeNotesFromSyllables(out); currentIdx=0; renderSyll(); updateTarget(); buildHighwayCache(); }

    function loadPart(key){ const part = PARTS[key]; if(!part) return; $('sylText').value = part.text; const pm = (part.mode==='psalmtone'); $('psalmMode').checked = pm; buildFromTextWithDegrees(part); }

    function buildFromTextWithDegrees(part){ const pieces = part.text.split('|').map(s=>s.trim()).filter(Boolean); const base=parseInt($('rootNum').value||root,10); root=base; let degs; if(part.mode==='psalmtone'){ degs = buildPsalmToneDegrees(pieces.length); } else if(part.degrees){ degs = part.degrees; } else { degs = SCALE_MAJOR; }
      syllables = makeNotesFromSyllables(pieces.map((p,i)=>({ text:p, midi: base + (part.mode==='psalmtone' ? degs[i] : degs[i % degs.length]) })));
      currentIdx=0; renderSyll(); updateTarget(); buildHighwayCache(); }

    // ====== Playback & Highway timing ======
    let playStartMs = 0; let songBeat = 0; let lastMs = 0; let highwayCache = []; let totalBeats = 0;

    function buildHighwayCache(){
      let t=0; highwayCache = syllables.map(s => { const item={...s, startBeat:t, heldSec:0, complete:false}; t += s.dur||1; return item; }); totalBeats=t; }
    

    function start(){ if(playing || syllables.length===0) return; playing=true; playStartMs=performance.now(); songBeat=0; lastMs=0; currentIdx=0; tick(); timer=setInterval(tick, Math.max(120, 60000/bpm)); requestAnimationFrame(animate); }
    function stop(){ playing=false; if(timer) clearInterval(timer); }
    function tick(){ const s=syllables[currentIdx]; if(!s) return; const freq=midiToFreq(s.midi); playGuide(freq, Math.max(100, 60000/bpm*0.9)); currentIdx=(currentIdx+1)%syllables.length; updateTarget(); renderSyll(); }

    function updateTarget(){ const s=syllables[currentIdx]||syllables[0]; if(!s){ targetNoteEl.textContent='‚Äì'; return; } targetNoteEl.textContent = midiToName(s.midi) + ' ('+midiToFreq(s.midi).toFixed(1)+' Hz)'; }

    function updateDetected(freq){ if(!freq){ lastFreq=null; lastCents=null; detectedNoteEl.textContent='‚Äì'; devTextEl.textContent='Abweichung: ‚Äì'; devBarEl.style.width='0%'; devBarEl.style.background='#d1d5db'; return; }
      lastFreq=freq; const target = syllables[currentIdx]? midiToFreq(syllables[currentIdx].midi) : (syllables[0]?midiToFreq(syllables[0].midi):null); const midi = freqToMidi(freq); detectedNoteEl.textContent = `${midiToName(midi)} (${freq.toFixed(1)} Hz)`; if(target){ const cents = 1200*Math.log2(freq/target); lastCents=cents; devTextEl.textContent = `Abweichung: ${cents.toFixed(0)} Cent`; const w = Math.min(100, Math.abs(cents)/50*100); devBarEl.style.width = w+'%'; devBarEl.style.background = Math.abs(cents)<=30? 'var(--ok)' : (cents>30? 'var(--hi)':'var(--lo)'); } }

    function midiToY(m){ const rangeTop = root+12; const rangeBottom = root-12; const y = (1 - (m - rangeBottom) / (rangeTop - rangeBottom)) * (canvas.height-20) + 10; return y; }

    function drawHighway(now){
      if(lastMs===0) lastMs=now; const dt = (now - lastMs)/1000; lastMs=now; if(playing){ songBeat = ((now - playStartMs) / 1000) * (bpm/60); }
      const w = canvas.width, h = canvas.height, pxPerBeat=view.pxPerBeat, hitX=view.hitX; const ctx2 = g;
      ctx2.clearRect(0,0,w,h); ctx2.fillStyle='#0b1220'; ctx2.fillRect(0,0,w,h);

      // Staff lines (treble-ish)
      if(document.getElementById('showNotation').checked){
        ctx2.strokeStyle='#172036'; ctx2.lineWidth=1;
        const lines = [76,74,72,71,69]; // rough staff sample MIDI lines
        lines.forEach(m=>{ const y=midiToY(m); ctx2.beginPath(); ctx2.moveTo(0,y); ctx2.lineTo(w,y); ctx2.stroke(); });
      }

      // Grid
      ctx2.strokeStyle='#1f2a44'; ctx2.lineWidth=1;
      for(let i=0;i<16;i++){ const x = w - i*pxPerBeat; ctx2.beginPath(); ctx2.moveTo(x,0); ctx2.lineTo(x,h); ctx2.stroke(); }
      // Hit line
      ctx2.strokeStyle='#94a3b8'; ctx2.beginPath(); ctx2.moveTo(hitX,0); ctx2.lineTo(hitX,h); ctx2.stroke();

      // Notes + progress
      let active = null;
      highwayCache.forEach(n=>{
        const relBeats = n.startBeat - songBeat; const x = w - relBeats*pxPerBeat; const wid = (n.dur||1)*pxPerBeat*0.95; const y = midiToY(n.midi); const nh=14;
        if(x+wid<0 || x>w) return;
        // Base bar
        ctx2.fillStyle='#334155'; ctx2.fillRect(x, y - nh/2, wid, nh);
        // Fill progress
        const needSec = (n.dur||1) * 60 / bpm; const ratio = Math.min(1, n.heldSec / needSec);
        if(ratio>0){ ctx2.fillStyle='rgba(34,197,94,0.9)'; ctx2.fillRect(x, y - nh/2, wid*ratio, nh); }
        if(n.complete){ ctx2.strokeStyle='#16a34a'; ctx2.lineWidth=2; ctx2.strokeRect(x+0.5, y - nh/2 + 0.5, wid-1, nh-1); }
        // Notehead
        if(document.getElementById('showNotation').checked){ ctx2.fillStyle='#e5e7eb'; const headW=10, headH=7; const cx=x+8; ctx2.save(); ctx2.translate(cx,y); ctx2.rotate(-0.3); ctx2.beginPath(); ctx2.ellipse(0,0,headW,headH,0,0,Math.PI*2); ctx2.fill(); ctx2.restore(); }
        if(!active && x <= hitX && hitX <= x+wid) active = {n, needSec};
      });

      // Update hold on active
      if(active){ if(lastCents!=null && Math.abs(lastCents)<=30){ active.n.heldSec += dt; if(active.n.heldSec >= active.needSec) active.n.complete = true; } }

      // Detected pitch marker
      if(lastFreq){ const y = midiToY(freqToMidi(lastFreq)); ctx2.fillStyle='#eab308'; ctx2.beginPath(); ctx2.arc(w-8, y, 5, 0, Math.PI*2); ctx2.fill(); }
    }
      const w = canvas.width, h = canvas.height, pxPerBeat=90, hitX=110; const ctx2 = g;
      ctx2.clearRect(0,0,w,h); ctx2.fillStyle='#0b1220'; ctx2.fillRect(0,0,w,h);
      // Grid
      ctx2.strokeStyle='#1f2a44'; ctx2.lineWidth=1;
      for(let i=0;i<16;i++){ const x = w - i*pxPerBeat; ctx2.beginPath(); ctx2.moveTo(x,0); ctx2.lineTo(x,h); ctx2.stroke(); }
      // Hit line
      ctx2.strokeStyle='#94a3b8'; ctx2.beginPath(); ctx2.moveTo(hitX,0); ctx2.lineTo(hitX,h); ctx2.stroke();
      // Notes
      highwayCache.forEach(n=>{ const relBeats = n.startBeat - songBeat; const x = w - relBeats*pxPerBeat; const wid = (n.dur||1)*pxPerBeat*0.95; const y = midiToY(n.midi); const nh=14; if(x+wid<0 || x>w) return; let color='#334155'; const near = Math.abs(x - hitX) < 14; if(near && lastCents!=null){ color = Math.abs(lastCents)<=30? '#16a34a' : (lastCents>30? '#ea580c' : '#2563eb'); } ctx2.fillStyle=color; ctx2.fillRect(x, y - nh/2, wid, nh); });
      // Detected pitch marker
      if(lastFreq){ const y = midiToY(freqToMidi(lastFreq)); ctx2.fillStyle='#eab308'; ctx2.beginPath(); ctx2.arc(w-8, y, 5, 0, Math.PI*2); ctx2.fill(); }
    }

    function animate(now){ drawHighway(now||performance.now()); if(playing) requestAnimationFrame(animate); }

    // Visibility: resume animation when tab regains focus
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && playing){ requestAnimationFrame(animate); } });

    // ====== Global fallback handlers (for restrictive embeds) ======
    window.PS_play = function(){ try{ ensureAudio(); start(); const s=$('status'); if(s) s.textContent='Playing‚Ä¶'; return false; } catch(e){ console.error(e); alert('Play fehlgeschlagen: '+e.message); return false; } };
    window.PS_stop = function(){ try{ stop(); const s=$('status'); if(s) s.textContent=''; return false; } catch(e){ console.error(e); return false; } };
    window.PS_mic = function(){ try{ if(listening){ stopListening(); } else { ensureAudio(); startListening(); } const s=$('status'); if(s) s.textContent = listening ? 'Mikro aktiv' : ''; return false; } catch(e){ console.error(e); alert('Mikro konnte nicht gestartet werden.'); return false; } };
    window.PS_test = function(){ try{ ensureAudio(); playGuide(midiToFreq(60), 400); const s=$('status'); if(s) s.textContent='Testton (C4)'; setTimeout(()=>{ if($('status')) $('status').textContent=''; }, 600); return false; } catch(e){ console.error(e); return false; } };
    window.PS_load = function(){ try{ const key=$('part').value; if(!PARTS[key]){ alert('Teil nicht gefunden: '+key); return false; } loadPart(key); const s=$('status'); if(s) s.textContent='Teil geladen: '+(PARTS[key]?.title||key); setTimeout(()=>{ if($('status')) $('status').textContent=''; }, 1200); return false; } catch(e){ console.error(e); alert('Fehler beim Laden des Teils.'); return false; } };

    // ====== UI wiring ======
    function bind(id, type, handler){ const el = $(id); if(!el){ console.warn('Element fehlt:', id); return; } el.addEventListener(type, handler); }

    function initUI(){
      bind('btnPlay','click',()=>{ ensureAudio(); start(); $('status') && ($('status').textContent='Playing‚Ä¶'); });
      bind('btnStop','click',()=>{ stop(); $('status') && ($('status').textContent=''); });
      bind('btnMic','click',()=>{ listening? (stopListening(), $('status') && ($('status').textContent='')) : (startListening(), $('status') && ($('status').textContent='Mikro aktiv')); });
      bind('btnTest','click',()=>{ ensureAudio(); playGuide(midiToFreq(60), 400); $('status') && ($('status').textContent='Testton (C4)'); setTimeout(()=>{$('status') && ($('status').textContent='');},600); });
      bind('gain','input',(e)=>{ gainVal=parseFloat(e.target.value); ensureAudio(); masterGain.gain.value=gainVal; });
      bind('bpm','input',(e)=>{ bpm=parseInt(e.target.value,10); $('bpmVal').textContent=bpm; });
      bind('btnRebuild','click',()=> buildFromText());
      bind('btnLoadPart','click',()=>{ try{ const key=$('part').value; if(!PARTS[key]){ alert('Teil nicht gefunden: '+key); return; } loadPart(key); $('status') && ($('status').textContent='Teil geladen: '+(PARTS[key]?.title||key)); setTimeout(()=>{$('status') && ($('status').textContent='');},1200);} catch(e){ console.error(e); alert('Fehler beim Laden des Teils. Konsole pr√ºfen.'); } });
    }

    // Fill part select
    const partSel=$('part'); Object.entries(PARTS).forEach(([k,v])=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=v.title; partSel.appendChild(opt); });

    // Init
    function initParts(){
      try{
        const partSel=$('part');
        if(partSel && partSel.options.length < 2){
          partSel.innerHTML = '';
          Object.entries(PARTS).forEach(([k,v])=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=v.title; partSel.appendChild(opt); });
        }
        $('sylText').value = PARTS.invitatorium_antiphon.text;
        loadPart('invitatorium_antiphon');
        $('status') && ($('status').textContent='Bereit');
      } catch(e){ console.error(e); $('status') && ($('status').textContent='Fehler beim Laden. Konsole pr√ºfen.'); }
    }

    function init(){ sizeCanvas(); initParts(); initUI(); requestAnimationFrame(animate); }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', ()=>{ init(); });
    } else { init(); }
    
    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); } }
    window.addEventListener('resize', debounce(()=>{ sizeCanvas(); }, 120));

    // Fehleranzeige
    window.addEventListener('error', (e)=>{ console.error('JS-Error', e.message); const s=$('status'); if(s){ s.textContent='Fehler: '+e.message; } });
  </script>
</body>
</html>

